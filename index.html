<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>動物落下ゲーム</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #gameArea {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-color: #87CEEB; /* 空の色 */
    }

    #field {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 100px;
      background-color: #228B22; /* 草地 */
    }

    .fallingAnimal {
      position: absolute;
      font-size: 40px;
      top: -40px; /* 画面外からスタート */
      transition: left 0.2s ease;
    }
  </style>
</head>
<body>
  <div id="gameArea">
    <div id="field"></div> <!-- フィールド（草地） -->
  </div>

  <script>
    const gameArea = document.getElementById("gameArea");
    const field = document.getElementById("field");
    const animals = ["🐧", "🐬", "🐼", "🐯", "🦁"]; // 新しい動物の絵文字

    let animalSpeed = 3; // 落下速度
    let isFalling = false; // 落下中かどうか
    let isMovingAllowed = false; // 動物が動くことを許可するフラグ（初期状態は動かない）
    let animalsOnField = []; // 画面に表示されている動物たち

    // 動物をランダムに設定
    function setAnimal() {
      const animalIndex = Math.floor(Math.random() * animals.length);
      const animal = document.createElement('div');
      animal.textContent = animals[animalIndex];
      animal.classList.add("fallingAnimal");

      // ランダムに位置設定
      const animalWidth = 40;
      const maxLeft = gameArea.clientWidth - animalWidth;
      animal.style.left = `${Math.random() * maxLeft}px`;

      // 動物がすでに落ちている位置と重ならないようにチェック
      if (!isPositionAvailable(animal)) {
        setAnimal(); // 再帰的に呼び出し
        return;
      }

      gameArea.appendChild(animal);
      animalsOnField.push(animal); // 新しい動物を追加

      animal.style.top = "-40px"; // 上からスタート
      return animal;
    }

    // 落下させる
    function fall() {
      if (!isFalling) return;

      let allFallen = true; // すべての動物が落ちたかを判定
      animalsOnField.forEach(animal => {
        let topPosition = parseInt(animal.style.top);
        const fieldTop = gameArea.clientHeight - field.clientHeight - 40; // フィールドの上端位置

        // 動物がフィールドの下端を越えないように調整
        if (topPosition < fieldTop) {
          animal.style.top = topPosition + animalSpeed + "px";
          allFallen = false; // 少なくとも1つの動物はまだ落下している
        } else {
          animal.style.top = fieldTop + "px"; // フィールド上に停止
        }
      });

      if (!allFallen) {
        requestAnimationFrame(fall); // 1フレームごとに落下
      }
    }

    // 動物の位置が他の動物と重ならないかをチェック
    function isPositionAvailable(animal) {
      const animalLeft = parseInt(animal.style.left);
      const animalWidth = 40;
      const animalHeight = 40;

      for (let i = 0; i < animalsOnField.length; i++) {
        const existingAnimal = animalsOnField[i];
        const existingAnimalLeft = parseInt(existingAnimal.style.left);
        const existingAnimalTop = parseInt(existingAnimal.style.top);

        // 重なっている場合は不適切な位置として返す
        if (
          animalLeft < existingAnimalLeft + animalWidth &&
          animalLeft + animalWidth > existingAnimalLeft &&
          existingAnimalTop < animalHeight
        ) {
          return false;
        }
      }

      return true; // 重ならなければ位置は有効
    }

    // タップまたはフリックで位置変更（動物がまだ落下していない場合のみ）
    gameArea.addEventListener("touchstart", (e) => {
      if (isMovingAllowed) {
        const touchX = e.touches[0].clientX;
        // フィールドの範囲内で動物の位置を調整
        const fieldLeft = field.getBoundingClientRect().left;
        const fieldRight = field.getBoundingClientRect().right;
        if (touchX >= fieldLeft && touchX <= fieldRight) {
          const currentAnimal = animalsOnField[animalsOnField.length - 1];
          currentAnimal.style.left = touchX - currentAnimal.clientWidth / 2 + "px";
        }
      }
    });

    gameArea.addEventListener("touchmove", (e) => {
      if (isMovingAllowed) {
        const touchX = e.touches[0].clientX;
        // フィールドの範囲内で動物の位置を調整
        const fieldLeft = field.getBoundingClientRect().left;
        const fieldRight = field.getBoundingClientRect().right;
        if (touchX >= fieldLeft && touchX <= fieldRight) {
          const currentAnimal = animalsOnField[animalsOnField.length - 1];
          currentAnimal.style.left = touchX - currentAnimal.clientWidth / 2 + "px";
        }
      }
    });

    // 動物の位置を設定し、落下を開始する
    function startGame() {
      const newAnimal = setAnimal(); // 動物を設定
      if (!newAnimal) return; // 位置が重なっていた場合は処理を中断

      isMovingAllowed = true; // ユーザーが操作可能に
      isFalling = true; // 落下開始
      fall(); // 動物を落下させる
    }

    // ゲームスタートのトリガー（タップまたはフリックでスタート）
    gameArea.addEventListener("click", () => {
      if (!isFalling) {
        startGame(); // 最初のタップで落下を開始
      }
    });

  </script>
</body>
</html>
